graph TD
    %% 定義樣式
    classDef data fill:#e1f5fe,stroke:#01579b,stroke-width:2px;
    classDef model fill:#fff9c4,stroke:#fbc02d,stroke-width:2px;
    classDef sim fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px;
    classDef viz fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px;
    classDef main fill:#eceff1,stroke:#455a64,stroke-width:2px,stroke-dasharray: 5 5;

    subgraph Main_Flow [Main Execution Flow]
        direction TB
        Start((Start)) --> Setup[1. Setup & Config]
        Setup --> PreprocStep[2. Preprocessing]
        PreprocStep --> TrainStep[3. Train Main Model]
        TrainStep --> SimTrainStep[4. Train Simulator]
        SimTrainStep --> DemoLoop[5. Demo Loop / Rounds]
    end

    subgraph Data_Layer [Data Processing]
        Config[Config & Settings]
        RawData[(Excel Data)]
        Preprocessor[DataPreprocessor]
        Dataset[TaskDataset]
        
        Config --> Preprocessor
        RawData --> Preprocessor
        Preprocessor -- "Create Features (X, y)" --> Dataset
    end

    subgraph Model_Layer [Prediction & Assignment]
        Trainer[Trainer]
        Predictor[ScorePredictor\n(Neural Network)]
        Assigner[TaskAssigner]
        
        Dataset --> Trainer
        Trainer -- "Cross Validation & Training" --> Predictor
        Predictor -- "Load Best State" --> Assigner
    end

    subgraph Simulation_Layer [Simulation Environment]
        SimTrainer[SimulatorTrainer]
        Simulator[TaskExecutionSimulator]
        Growth[Growth Tracker]
        
        Preprocessor --> SimTrainer
        SimTrainer -- "Train Internal Model" --> Simulator
        Simulator --> Growth
    end

    subgraph Visualization_Layer [Visualization]
        VizFuncs[Visualization Module]
        Charts[Charts & Reports]
        
        VizFuncs --> Charts
    end

    %% 流程連接
    Setup -.-> Config
    PreprocStep -.-> Preprocessor
    TrainStep -.-> Trainer
    SimTrainStep -.-> SimTrainer

    %% Demo Loop 詳細邏輯
    DemoLoop --> TaskSlots[Define Task Slots]
    TaskSlots --> AssignCall[Step 1: Assignment]
    AssignCall --> Assigner
    Assigner -- "Predict Scores" --> Predictor
    Assigner -- "Hungarian Algo" --> OptAssign[Optimal Assignment]
    
    OptAssign --> ExecCall[Step 2: Execution]
    ExecCall --> Simulator
    Simulator -- "Calculate Actual Score\nCheck Penalty\nUpdate Skills" --> ExecResults[Execution Results]
    
    ExecResults --> VizCall[Step 3: Visualization]
    VizCall --> VizFuncs

    %% 類別套用
    class Config,RawData,Preprocessor,Dataset data;
    class Trainer,Predictor,Assigner model;
    class SimTrainer,Simulator,Growth sim;
    class VizFuncs,Charts viz;
    class Main_Flow,Start,Setup,PreprocStep,TrainStep,SimTrainStep,DemoLoop,TaskSlots,AssignCall,ExecCall,VizCall main;
